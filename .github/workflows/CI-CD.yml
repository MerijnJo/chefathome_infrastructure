name: Infrastructure Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [backend-updated, frontend-updated]

permissions:
  contents: read
  packages: write

jobs:
  build-and-test-integration:
    name: Build & Test Full Stack
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: chefathome_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout infrastructure repo
        uses: actions/checkout@v4

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome_backend
          path: backend
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Checkout frontend repo
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome_frontend
          path: frontend
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        run: |
          cd backend/chefbackend
          docker build -t chefathome-backend .

      - name: Build frontend Docker image
        run: |
          cd frontend/cheffrontend
          docker build -t chefathome-frontend .

      - name: Create .env file for docker-compose
        run: |
          cat > .env << EOF
          POSTGRES_DB=chefathome_test
          POSTGRES_USER=test
          POSTGRES_PASSWORD=test
          DB_PORT=5432
          BACKEND_PORT=8080
          FRONTEND_PORT=3001
          EOF

      - name: Start full stack with Docker Compose
        run: |
          docker compose -f chefinfrastructure/docker-compose.ci.yml up -d
          sleep 30

      - name: Check container status
        run: |
          docker compose -f chefinfrastructure/docker-compose.ci.yml ps
          echo "=== Backend logs ==="
          docker logs cah-backend --tail 50
          echo "=== Frontend logs ==="
          docker logs cah-frontend --tail 50

      - name: Wait for backend health
        run: |
          echo "Checking backend health..."
          timeout 90 bash -c 'until curl -sf http://localhost:8080/actuator/health > /dev/null; do echo "Waiting..."; sleep 3; done'
          echo "âœ… Backend is healthy!"

      - name: Wait for frontend
        run: |
          echo "Checking frontend..."
          timeout 60 bash -c 'until curl -sf http://localhost:3001 > /dev/null; do echo "Waiting..."; sleep 2; done'
          echo "âœ… Frontend is responding!"

      - name: Run E2E tests (Playwright)
        working-directory: ./frontend
        run: |
          npm ci
          npx playwright install --with-deps chromium
          npx playwright test
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8080

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Stop Docker Compose
        if: always()
        run: docker compose -f chefinfrastructure/docker-compose.ci.yml down

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and push backend image
        run: |
          docker tag chefathome-backend ${{ secrets.DOCKER_USERNAME }}/chefathome-backend:latest
          docker tag chefathome-backend ${{ secrets.DOCKER_USERNAME }}/chefathome-backend:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/chefathome-backend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/chefathome-backend:${{ github.sha }}

      - name: Tag and push frontend image
        run: |
          docker tag chefathome-frontend ${{ secrets.DOCKER_USERNAME }}/chefathome-frontend:latest
          docker tag chefathome-frontend ${{ secrets.DOCKER_USERNAME }}/chefathome-frontend:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/chefathome-frontend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/chefathome-frontend:${{ github.sha }}

  sonarqube-backend:
    name: SonarQube Backend
    needs: build-and-test-integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout backend
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome_backend
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and analyze
        working-directory: ./chefbackend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=MerijnJo_chefathome_backend \
            -Dsonar.organization=merijnjo \
            -Dsonar.host.url=https://sonarcloud.io

  sonarqube-frontend:
    name: SonarQube Frontend
    needs: build-and-test-integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout frontend
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome_frontend
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_FRONTEND }}
        with:
          args: >
            -Dsonar.projectKey=MerijnJo_chefathome_frontend
            -Dsonar.organization=merijnjo

  deploy:
    name: Deploy to Production
    needs: [sonarqube-backend, sonarqube-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infrastructure
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "âœ… All checks passed!"
          echo "ðŸš€ Ready to deploy:"
          echo "   - Backend: ${{ secrets.DOCKER_USERNAME }}/chefathome-backend:latest"
          echo "   - Frontend: ${{ secrets.DOCKER_USERNAME }}/chefathome-frontend:latest"
