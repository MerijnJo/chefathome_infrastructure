name: Infrastructure Deployment

on:
  repository_dispatch:
    types: [backend-updated, frontend-updated]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sonarqube-backend:
    name: SonarQube Backend Analysis
    runs-on: ubuntu-latest
    if: github.event.action == 'backend-updated'

    steps:
      - name: Checkout Backend Repository
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome-backend
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run SonarQube Analysis
        working-directory: ./chefbackend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=MerijnJo_chefathome_backend \
            -Dsonar.organization=merijnjo \
            -Dsonar.host.url=https://sonarcloud.io

  sonarqube-frontend:
    name: SonarQube Frontend Analysis
    runs-on: ubuntu-latest
    if: github.event.action == 'frontend-updated'

    steps:
      - name: Checkout Frontend Repository
        uses: actions/checkout@v4
        with:
          repository: MerijnJo/chefathome-frontend
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Run SonarQube Analysis
        uses: sonarsource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=MerijnJo_chefathome_frontend
            -Dsonar.organization=merijnjo

  deploy:
    name: Deploy Infrastructure
    needs: [sonarqube-backend, sonarqube-frontend]
    runs-on: ubuntu-latest
    if: always() && !cancelled()

    steps:
      - uses: actions/checkout@v4

      - name: Deploy infrastructure updates
        run: |
          echo "Deploying infrastructure..."
          echo "Triggered by: ${{ github.event.action }}"
